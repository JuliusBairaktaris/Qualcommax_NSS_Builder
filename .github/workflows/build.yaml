name: OpenWrt Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: "0 */2 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  # Repository Configuration
  REMOTE_REPOSITORY: qosmio/openwrt-ipq
  REMOTE_BRANCH: main-nss
  NSS_PACKAGES_REPOSITORY: qosmio/nss-packages
  NSS_PACKAGES_REPOSITORY_BRANCH: NSS-12.5-K6.x

  # Build Configuration
  CONFIG_FILE: ax3600.config
  CUSTOM_FILES_PATH: files

  # Release Configuration
  RELEASE_PREFIX: main-nss
  ARTIFACT_RETENTION_DAYS: 7
  RELEASES_TO_KEEP: 2

jobs:
  check_updates:
    name: Check for Updates
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      GH_TOKEN: ${{ github.token }}
    outputs:
      build_required: ${{ steps.check.outputs.build_required }}
      main_sha: ${{ steps.check.outputs.main_sha }}
      nss_sha: ${{ steps.check.outputs.nss_sha }}
    steps:
      - name: Check upstream changes
        id: check
        run: |
          set -euo pipefail

          # Fetch upstream SHAs
          main_sha=$(gh api "repos/${REMOTE_REPOSITORY}/commits/${REMOTE_BRANCH}" --jq .sha)
          nss_sha=$(gh api "repos/${NSS_PACKAGES_REPOSITORY}/commits/${NSS_PACKAGES_REPOSITORY_BRANCH}" --jq .sha)

          # Get latest release body safely
          latest_release_body=$(gh release view --repo "${GITHUB_REPOSITORY}" --json body --jq .body 2>/dev/null || echo "")

          # Determine if build is required
          build_required=true
          if [[ "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]] && \
             [[ "$latest_release_body" == *"$main_sha"* ]] && \
             [[ "$latest_release_body" == *"$nss_sha"* ]]; then
            build_required=false
          fi

          echo "Build required: $build_required"
          echo "Main SHA: $main_sha"
          echo "NSS SHA: $nss_sha"

          # Output results
          cat >> "$GITHUB_OUTPUT" <<EOF
          build_required=$build_required
          main_sha=$main_sha
          nss_sha=$nss_sha
          EOF

  build_firmware:
    name: Build Firmware
    needs: check_updates
    if: needs.check_updates.outputs.build_required == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    permissions:
      contents: write
      actions: read
    outputs:
      release_tag: ${{ steps.release.outputs.release_tag }}
    env:
      MAIN_SHA: ${{ needs.check_updates.outputs.main_sha }}
      NSS_SHA: ${{ needs.check_updates.outputs.nss_sha }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git \
            libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: Checkout source code
        uses: actions/checkout@v6
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          ref: ${{ env.MAIN_SHA }}
          fetch-depth: 0
          path: openwrt

      - name: Checkout builder assets
        uses: actions/checkout@v6
        with:
          path: builder_repo
          fetch-depth: 0

      - name: Prepare build environment
        working-directory: openwrt
        run: |
          set -euo pipefail

          # Apply patches if they exist
          if compgen -G '../builder_repo/patches/*.patch' >/dev/null; then
            echo "Applying patches..."
            while IFS= read -r patch; do
              echo "Applying $patch"
              git apply --verbose "$patch"
            done < <(find ../builder_repo/patches -maxdepth 1 -type f -name '*.patch' | sort)
          fi

          # Add custom feed
          if [ ! -f feeds.conf ]; then
            cp feeds.conf.default feeds.conf
          fi
          echo "src-git qosmio https://github.com/qosmio/packages-extra" >> feeds.conf

          # Update and install feeds
          ./scripts/feeds update qosmio
          ./scripts/feeds install -a -p qosmio
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # Configure
          cp "../builder_repo/${CONFIG_FILE}" .config
          make defconfig

          # Disable bundling custom repos
          sed -i 's/^CONFIG_FEED_luci_extra=.*/# CONFIG_FEED_luci_extra is not set/' .config
          sed -i 's/^CONFIG_FEED_qosmio=.*/# CONFIG_FEED_qosmio is not set/' .config

          # Add custom files
          if [ -d "../builder_repo/${CUSTOM_FILES_PATH}" ]; then
            echo "Adding custom files..."
            mkdir -p "${CUSTOM_FILES_PATH}"
            rsync -a "../builder_repo/${CUSTOM_FILES_PATH}/" "${CUSTOM_FILES_PATH}/"

            # Ensure correct permissions for sshd_config
            if [ -f "${CUSTOM_FILES_PATH}/etc/ssh/sshd_config" ]; then
              chmod 0600 "${CUSTOM_FILES_PATH}/etc/ssh/sshd_config"
            fi
          fi

          # Set reproducible build parameters
          main_epoch=$(git show -s --format=%ct HEAD)
          cat >> "$GITHUB_ENV" <<EOF
          SOURCE_DATE_EPOCH=$main_epoch
          TZ=UTC
          LC_ALL=C
          KBUILD_BUILD_USER=builder
          KBUILD_BUILD_HOST=github
          EOF

      - name: Build
        working-directory: openwrt
        run: |
          set -euo pipefail

          echo "Starting download..."
          make download -j"$(nproc)" V=s

          echo "Starting build..."
          if ! make -j"$(nproc)"; then
            echo "Build failed, retrying with single thread for debugging..."
            make -j1 V=s
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ipq807x-images
          path: openwrt/bin/targets/qualcommax/ipq807x
          if-no-files-found: error
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Publish release
        id: release
        run: |
          set -euo pipefail

          date=$(date -u +%F)
          timestamp=$(date -u +%Y%m%dT%H%M%SZ)
          tag_name="${RELEASE_PREFIX}-${timestamp}-${GITHUB_RUN_ID}"
          echo "release_tag=$tag_name" >> "$GITHUB_OUTPUT"

          # Create release notes
          cat > release_notes.md <<EOF
          ## OpenWrt Automated Build
          - **Date**: $date
          - **Main Commit**: \`${{ needs.check_updates.outputs.main_sha }}\`
          - **NSS Commit**: \`${{ needs.check_updates.outputs.nss_sha }}\`
          - **Trigger**: \`${{ github.event_name }}\`
          EOF

          gh release create "$tag_name" \
            --repo "$GITHUB_REPOSITORY" \
            --title "OpenWrt Build $date" \
            --notes-file release_notes.md \
            $(find openwrt/bin/targets/qualcommax/ipq807x/ -type f -not -path "*/packages/*")

  cleanup_releases:
    name: Cleanup Old Releases
    needs: build_firmware
    if: always()
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Prune releases
        run: |
          set -euo pipefail

          keep="${RELEASES_TO_KEEP:-2}"
          current_tag="${{ needs.build_firmware.outputs.release_tag }}"

          echo "Keeping last $keep releases..."
          if [ -n "$current_tag" ]; then
            echo "Protecting current release: $current_tag"
          fi

          # Fetch and filter releases to delete
          gh api "repos/${GITHUB_REPOSITORY}/releases?per_page=100" | \
          jq -r --argjson keep "$keep" --arg current_tag "$current_tag" '
            map(select(.draft | not)) | sort_by(.created_at) | reverse | .[$keep:] | .[] | select(.tag_name != $current_tag) | "\(.id) \(.tag_name)"
          ' | while read -r release_id tag_name; do
            echo "Deleting release $release_id (tag: $tag_name)"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/releases/${release_id}"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/git/refs/tags/${tag_name}" || true
          done
